rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isFarmMember(farmId) {
      return isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/farms/$(farmId)).data.memberIds;
    }

    function isFarmOwner(farmId) {
      let farm = get(/databases/$(database)/documents/farms/$(farmId)).data;
      return isAuthenticated() && request.auth.uid == farm.ownerId;
    }

    // Check if user has a pending invitation to join this farm
    function hasPendingInvitation(farmId) {
      return isAuthenticated();
      // Note: We allow any authenticated user to add themselves to a farm
      // if they're only adding themselves to the members array.
      // The actual invitation validation is done in the application code.
    }

    // Users collection
    match /users/{userId} {
      // Allow users to read/write their own document
      allow read, write: if isOwner(userId);

      // User's farm memberships
      match /farms/{farmId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // Farms collection
    match /farms/{farmId} {
      // Allow authenticated users to create farms
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid;

      // Allow farm members to read, or anyone with a pending invitation
      allow read: if isFarmMember(farmId) || isAuthenticated();

      // Allow farm owner to update/delete, OR allow authenticated users to add themselves as members
      // (invitation validation happens in application code)
      allow update: if isFarmOwner(farmId) ||
                       (isAuthenticated() &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'memberIds']));
      allow delete: if isFarmOwner(farmId);

      // Farm's shipments subcollection
      match /shipments/{shipmentId} {
        allow read: if isFarmMember(farmId);
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmOwner(farmId);
      }

      // Farm's fish instances subcollection
      match /fish_instances/{instanceId} {
        allow read: if isAuthenticated();
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmMember(farmId);
      }

      // Farm's aquariums subcollection
      match /aquariums/{aquariumId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isFarmMember(farmId);
      }

      // Farm's tasks subcollection
      match /tasks/{taskId} {
        allow read: if isFarmMember(farmId);
        allow create, update, delete: if isFarmMember(farmId);
      }

      // Farm's invitations subcollection
      match /invitations/{invitationId} {
        allow read: if isFarmOwner(farmId);
        allow create, update, delete: if isFarmOwner(farmId);
      }

      // Farm's reception plans subcollection
      match /reception_plans/{planId} {
        allow read: if isFarmMember(farmId);
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmMember(farmId);

        // Farm's reception items subcollection (nested under reception plans)
        match /items/{itemId} {
          allow read: if isFarmMember(farmId);
          allow create: if isFarmMember(farmId);
          allow update, delete: if isFarmMember(farmId);
        }
      }

      // Farm's reception items subcollection (top-level)
      match /reception_items/{itemId} {
        allow read: if isFarmMember(farmId);
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmMember(farmId);
      }

      // Farm's transfer plans subcollection
      match /transfer_plans/{planId} {
        allow read: if isFarmMember(farmId);
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmMember(farmId);

        // Farm's transfer tasks subcollection (nested under transfer plans)
        match /tasks/{taskId} {
          allow read: if isFarmMember(farmId);
          allow create: if isFarmMember(farmId);
          allow update, delete: if isFarmMember(farmId);
        }
      }

      // Farm's transfer tasks subcollection (top-level)
      match /transfer_tasks/{taskId} {
        allow read: if isFarmMember(farmId);
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmMember(farmId);
      }

      // Farm's mortality events subcollection
      match /mortality_events/{eventId} {
        allow read: if isFarmMember(farmId);
        allow create: if isFarmMember(farmId);
        allow update, delete: if isFarmMember(farmId);
      }
    }

    // Farm fish collection (local/farm-sourced fish)
    match /farmFish/{fishId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       isFarmMember(request.resource.data.farmId);
      allow update, delete: if isAuthenticated() &&
                               isFarmMember(resource.data.farmId);
    }

    // Order portals — public read so the shop page can look up farmId by token
    match /orderPortals/{token} {
      allow read: if true;
      allow create: if isAuthenticated() &&
                       isFarmMember(request.resource.data.farmId);
      allow update, delete: if isAuthenticated() &&
                               isFarmMember(resource.data.farmId);
    }

    // Orders — anonymous users can create (token validated server-side),
    //           farm members can read and update
    match /orders/{orderId} {
      allow create: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/orderPortals/$(request.resource.data.token)) &&
                       get(/databases/$(database)/documents/orderPortals/$(request.resource.data.token)).data.farmId == request.resource.data.farmId &&
                       get(/databases/$(database)/documents/orderPortals/$(request.resource.data.token)).data.active == true;
      allow read, update: if isFarmMember(resource.data.farmId);
    }

    // Global invitations collection (for code-based invites)
    match /invitations/{invitationId} {
      // Any authenticated user can read invitations (needed for join flow)
      allow read: if isAuthenticated();
      // Any authenticated user can create invitations
      allow create: if isAuthenticated();
      // Only the inviter can update/delete, or the person accepting
      allow update: if isAuthenticated() &&
                       (resource.data.invitedBy == request.auth.uid ||
                        resource.data.status == 'pending');
      allow delete: if isAuthenticated() &&
                       resource.data.invitedBy == request.auth.uid;
    }
  }
}
