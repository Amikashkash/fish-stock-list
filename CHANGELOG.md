# יומן שינויים - Fish Stock Management System

## [1.15.0] - 2026-01-06

### תכונות חדשות ✨
- **עריכת תוכניות העברות קיימות**: כעת ניתן לערוך תוכניות העברות קיימות
  - פותר בעיית יצירת תוכניות חדשות בעת הפרעה/הפסקה
  - מונע בלבול בין תוכניות שונות
  - ניתן לפתוח תוכנית קיימת לעריכה
  - אפשרות למחוק משימות בודדות מתוכנית
  - כותרת מציינת מצב עריכה: "עריכת תוכנית העברות"
  - כל משימה כוללת כפתור מחיקה במצב עריכה (🗑️)

### שיפורים טכניים 🔧
- TransferPlanModal.jsx: תמיכה ב-prop existingPlan
- הוספת מצב עריכה (isEditMode)
- פונקציה loadExistingPlan() לטעינת תוכניות קיימות
- פונקציה handleDeleteTask() למחיקת משימות בודדות
- ממשק אינטואיטיבי עם סימון ויזואלי למצב עריכה (📝)

---

## [1.14.1] - 2026-01-04

### תיקוני באגים 🐛
- **תוקן: שגיאה בביצוע העברות**: תוקנה שגיאת "Unsupported field value: undefined"
  - בעיה: שדה `shipmentReference` עם ערך undefined נשמר ל-Firestore
  - Firestore לא מאפשר ערכי undefined
  - פתרון: מסננים ומוחקים שדות undefined לפני שמירה
  - reception.service.js: הוספת בדיקה למחיקת undefined values
  - עכשיו ביצוע העברות עובד ללא שגיאות
- **פרסום אינדקסים**: פורסם אינדקס Firebase לשאילתות transfer_tasks
  - פותר שגיאת "The query requires an index"
  - אינדקס מורכב על planId + order
  - טעינת משימות בביצוע העברות עובדת

### שיפורים 🔧
- שיפור טיפול בשדות אופציונליים ב-updateReceptionPlan
- מניעת שגיאות Firestore עם ערכים לא חוקיים

---

## [1.14.0] - 2026-01-04

### תכונות חדשות ✨
- **שדה מחיר אופציונלי בהוספת דגים ידנית**: כעת ניתן להוסיף מחיר ליחידה בעת הוספת דג חדש
  - שדה "מחיר ליחידה (₪)" חדש בטופס הוספת דג
  - השדה אופציונלי - אין חובה למלא
  - מתאים למשלוחי יבוא שנרשמים ידנית
  - המחיר נשמר במסד הנתונים לכל דג
  - תומך במספרים עשרוניים (למשל: 12.50)

### שיפורים 🔧
- farm-fish.service.js: תמיכה בשדה price באופציונלי
- AquariumFishModal.jsx: שדה קלט חדש למחיר עם placeholder "אופציונלי"

---

## [1.13.3] - 2026-01-04

### שיפורים 🔧
- **פישוט ייבוא Excel**: הוסרה דרישת עמודת מטבע (Currency)
  - המטבע תמיד יהיה שקלים (ILS) באופן אוטומטי
  - עכשיו רק 9 עמודות במקום 10
  - חוויית שימוש פשוטה יותר - פחות טעויות
  - העמודות הנדרשות:
    1. Code (אופציונלי)
    2. Cart
    3. Scientific Name
    4. Common Name
    5. Size
    6. Bags
    7. Qty/Bag
    8. Total
    9. Price
  - נוצר קובץ לדוגמה חדש: fish-import-simple.xlsx

---

## [1.13.2] - 2026-01-04

### תיקוני באגים 🐛
- **תוקן: עדכון סטטוס אקווריום אוטומטי**: סטטוס אקווריום מתעדכן אוטומטית כשמעבירים דגים
  - בעיה: אקווריום הופיע כריק אף שהיו בו דגים
  - `updateAquariumStatus` הוחרג ל-export כדי שיוכל להיקרא מ-transfer.service
  - `updateFarmFish` משודרג - כשמעבירים דג, מעדכן גמצא את אקווריום המקור וגם את היעד
  - ב-`transferFish` כשמפצלים דגים, קוראים ל-`updateAquariumStatus` לאקווריום המקור
  - כעת סטטוס מתעדכן מיד לאחר העברה: "occupied" אם יש דגים, "empty" אם ריק
  - `totalFish` מתעדכן אוטומטית בכל פעולה

### שיפורים 🔧
- הוספת הערות מפורטות בקוד על זרימת עדכון הסטטוס
- תיקון סדר פעולות ב-`transferFish` - commit לפני `addFarmFish` כדי למנוע race conditions

---

## [1.13.1] - 2026-01-04

### תכונות חדשות ✨
- **מניעת כפילות אקווריומים**: המערכת בודקת ומונעת יצירת אקווריום עם מספר זהה באותו חדר
  - בדיקה מקומית בזמן יצירת אקווריום חדש
  - הודעת שגיאה ברורה: "אקווריום X כבר קיים בחדר Y. בחר מספר אחר"
  - מונע טעויות וערבוב בין אקווריומים
  - ניתן ליצור אקווריומים עם אותו מספר בחדרים שונים

---

## [1.13.0] - 2025-12-28

### תכונות חדשות ✨
- **מניעת העברה כפולה**: המערכת בודקת ומונעת הוספת אותו דג פעמיים לתוכנית
  - בדיקה מקומית (local validation) ללא צורך באינדקס Firebase
  - הודעת שגיאה ברורה: "דג X מאקווריום Y כבר נמצא בתוכנית ההעברות"
  - מונע טעויות והכפלת משימות

- **אזהרה על העברות ממתינות לאקווריום**: דיאלוג ערבוב משופר
  - מזהיר כשבוחרים אקווריום שמתוכנן לקבל דגים (לא רק עם דגים קיימים)
  - הודעה דינמית: "מכיל דגים" / "מתוכנן לקבל דגים" / "מכיל דגים וגם מתוכנן לקבל דגים"
  - בדיקה מקומית מול משימות התוכנית הנוכחית

### שיפורים 🔧
- **הודעת שגיאה משופרת ב"ביצוע העברות"**: כשאין אינדקס Firebase
  - הודעה ברורה: "שגיאה בטעינת משימות - חסר אינדקס Firebase. אנא צור את האינדקס או חכה כמה דקות"
  - מנחה את המשתמש לפתרון הבעיה

---

## [1.12.1] - 2025-12-28

### תיקוני באגים 🐛
- **תוקן: שגיאה בהוספת משימה שנייה**: תוקנה בעיה שחסמה הוספת משימות נוספות
  - כש-`validateTaskWarnings` נכשל (אין אינדקס), המשימה מתווספת בכל זאת
  - המשתמש לא נחסם יותר על ידי שגיאת "שגיאה בבדיקת התנגשויות"
  - מאפשר הוספת מספר בלתי מוגבל של משימות גם ללא אינדקס Firebase
  - בדיקת התנגשויות תופעל אוטומטית כשהאינדקס יהיה מוכן

---

## [1.12.0] - 2025-12-28

### תכונות חדשות ✨
- **דיאלוג אישור לערבוב דגים**: הצ'ק-בוקס הוחלף בדיאלוג אינטראקטיבי
  - כשבוחרים אקווריום עם דגים קיימים, מופיע דיאלוג ברור עם שאלת אישור
  - כפתורי "אישור ערבוב" ו-"ביטול" ברורים ונוחים לשימוש
  - חוויית משתמש משופרת - לא צריך לחפש צ'ק-בוקס קטן

### שיפורים 🔧
- **חזרה לשלב 1 אחרי הוספת משימה**: לאחר הוספת משימה, המערכת חוזרת לבחירת אקווריום מקור חדש
  - זרימת עבודה טבעית יותר
  - מאפשר הוספת העברות מאקווריומים שונים בקלות
- **תיקון הוספת משימות נוספות**: כעת ניתן להוסיף משימות מרובות ללא שגיאות
  - משימות מקבלות metadata מלא (taskId, status, timestamps)
  - מאפשר המשך עבודה חלקה גם ללא אינדקס Firebase

---

## [1.11.1] - 2025-12-28

### תיקוני באגים 🐛
- **תוקן: חזרה אוטומטית לשלב 2 לאחר הוספת משימה**: תוקנה בעיה שגרמה לחזרה לבחירת דג
  - כש-`loadTasks` נכשלת (אין אינדקס), המשימה מתווספת ידנית ל-state המקומי
  - המשתמש נשאר בשלב 2 (בחירת דג נוסף מאותו אקווריום מקור) כמתוכנן
  - מאפשר המשך הוספת משימות גם ללא אינדקס Firebase

---

## [1.11.0] - 2025-12-28

### תכונות חדשות ✨
- **יצירת תוכנית העברות מראש**: כעת התוכנית נוצרת אוטומטית בפתיחת המודל
  - פותר את בעיית "שגיאה בבדיקת התנגשויות" כשאין אינדקס
  - המשימה הראשונה בתוכנית מתווספת ללא בדיקת התנגשויות (אין עם מה להתנגש)
  - משימות נוספות עוברות בדיקת התנגשויות רק אם יש אינדקס
  - מאפשר שימוש בתכנון העברות גם ללא יצירת האינדקס ב-Firebase

### שיפורים 🔧
- השגיאה "שגיאה בבדיקת התנגשויות" לא תופיע יותר במשימה ראשונה
- חוויית משתמש משופרת - ניתן להתחיל לעבוד מיד ללא המתנה לאינדקס

---

## [1.10.2] - 2025-12-26

### תיקוני באגים 🐛
- **נוסף אינדקס Firestore ל-transfer_tasks**: תוקנה שגיאת "The query requires an index"
  - נוצר קובץ `firestore.indexes.json` עם אינדקס מורכב על `planId` + `order`
  - האינדקס נדרש עבור שאילתות שמחפשות משימות לפי תוכנית וממיינות לפי סדר
  - לאחר יצירת האינדקס ב-Firebase Console (כמה דקות), תכנון העברות יעבוד ללא שגיאות

---

## [1.10.1] - 2025-12-24

### תיקוני באגים 🐛
- **תוקן: שגיאת הרשאות ב-transfer_tasks**: נוספו הרשאות חסרות ל-`transfer_tasks` ב-firestore.rules
  - הבעיה: הקוד השתמש ב-`transfer_tasks` כקולקציה עצמאית, אבל הכללים הגדירו רק `tasks` מקוננת
  - התיקון: נוספו כללי הרשאות ל-`transfer_tasks` (שורות 115-120 ב-firestore.rules)
  - כעת יצירת תוכניות העברות עובדת ללא שגיאות הרשאות

---

## [1.10.0] - 2025-12-23

### תכונות חדשות ✨
- **העברה מיידית מתוך תכנון העברות**: כעת ניתן לבצע העברת דגים מיידית מתוך מסך תכנון ההעברות
  - צ'ק-בוקס חדש "✓ העברה בוצעה (עדכון מיידי)" בשלב 3
  - כשמסומן: ההעברה מבוצעת מיד ללא יצירת תוכנית
  - כשלא מסומן: ההתנהגות הרגילה - הוספה לתוכנית העברות
  - מתאים למצבים שבהם העברה כבר בוצעה פיזית ורק צריך לעדכן במערכת
  - הצ'ק-בוקס מוצג רק עבור העברות רגילות (לא משלוח)
  - לאחר ביצוע מיידי, המערכת חוזרת לשלב 1 ומטעינה מחדש את הנתונים

### שיפורים 🔧
- כפתור "הוסף למשימות" משתנה ל-"✓ בצע העברה" כשהצ'ק-בוקס מסומן
- הודעת הצלחה ברורה לאחר ביצוע העברה מיידית
- אפילו אם firestore.rules עדיין לא פורסם, ניתן לבצע העברות מיידיות

---

## [1.9.0] - 2025-12-23

### תיקוני באגים 🐛
- **תוקן: שגיאת הרשאות Firebase**: נוספו הרשאות ל-`transfer_plans` ב-firestore.rules
  - חסר היה הגדרת הרשאות לקולקציות transfer_plans ו-tasks
  - משתמשי חווה כעת יכולים ליצור ולנהל תוכניות העברה

### שיפורים 🔧
- **תצוגת דגים ברשימת אקווריומים (שלב 1)**: כעת רואים את כל הדגים שבאקווריום עוד לפני הבחירה
  - רשימת הדגים מוצגת ישירות בכרטיס האקווריום
  - כל דג מוצג עם: שם עברי, כמות וגודל
  - טעינה מהירה יותר - כל הדגים נטענים מראש
  - לא צריך ללחוץ על אקווריום כדי לראות מה בתוכו

---

## [1.8.0] - 2025-12-22

### תכונות חדשות ✨
- **שיפורים למערכת תכנון העברות**:
  - **סינון לפי אזורים** 📍: אפשרות לסנן אקווריומי מקור ויעד לפי אזורים/חדרים
    - סינון נפרד לאקווריום מקור (שלב 1)
    - סינון נפרד לאקווריום יעד (שלב 3)
    - מציג רק אקווריומים מהאזור הנבחר
  - **העברה למשלוח** 📦: אפשרות חדשה לסמן העברות כאריזה למשלוח
    - תיבת סימון בולטת בצבע כתום
    - במקום לבחור אקווריום יעד, מסמנים "העברה למשלוח"
    - העובד מקבל הוראה ברורה לארוז את הדגים
    - מוצג בממשק הביצוע עם אייקון 📦 משלוח
  - **הערות בולטות** 📝: שדה הערות משודרג ובולט יותר
    - הומר מ-input ל-textarea עם 3 שורות
    - רקע סגול בולט עם מסגרת
    - דוגמאות בתוך ה-placeholder: "לארוז מחר בבוקר", "לנקות פילטר אחרי פינוי", "להחליף מים אחרי פינוי"
    - הערות מוצגות בצורה בולטת גם בסיכום המשימות וגם בממשק הביצוע

### שיפורים 🔧
- תצוגה משופרת של משימות משלוח בכל הממשקים
- הערות מוצגות בקופסא סגולה בולטת במקום טקסט קטן
- חוויית משתמש משופרת עם סינון אזורים

---

## [1.7.0] - 2025-12-22

### תכונות חדשות ✨
- **מערכת תכנון וביצוע העברות**: מערכת מתקדמת לתכנון וביצוע העברות דגים
  - **תכנון העברות** (TransferPlanModal): יצירת תוכניות העברה עם מספר משימות
    - בחירת אקווריום מקור → בחירת דג → בחירת אקווריום יעד
    - הוספת מספר משימות לתוכנית אחת
    - בדיקת התנגשויות והתראות אוטומטיות
    - תמיכה בשרשור (emptying aquarium A, then filling A)
    - מעקב אחר משימות שנוספו
  - **ביצוע העברות** (TransferExecutionModal): ביצוע תוכניות בפועל
    - רשימת משימות ממוינת לפי סדר ביצוע
    - כפתורים: "בוצע ✓" ו-"תקוע ⚠️"
    - progress bar להתקדמות
    - מעקב אחר משימות שבוצעו, חסומות, ובוטלו
  - **התראות חכמות** (WarningDialog): זיהוי התנגשויות
    - אקווריום מתוכנן להתרוקן
    - אקווריום מתוכנן לקבל דגים
    - אקווריום תפוס (עם אפשרות mixing)
  - **דיווח תקלות** (BlockReportDialog): מנגנון דיווח וחסימה
    - 4 סוגי תקלות: טמפרטורה, גודל אקווריום, דליפה, אחר
    - שדה הערות חופשי
    - התראה למנהל
    - אפשרות למנהל להמשיך או לבטל משימה
  - **2 כפתורים חדשים בדף הבית**:
    - 📝 תכנון העברות
    - ▶️ ביצוע העברות

### שיפורים 🔧
- מצב וירטואלי של אקווריומים - מעקב אחר מצב עתידי לפי התוכנית
- סדר ביצוע קבוע למשימות - מונע טעויות
- תמיכה בהרשאות מנהל לאישור חסימות

---

## [1.6.2] - 2025-12-21

### תיקוני באגים 🐛
- **תוקן מודל העברת דגים**: תוקנה הבעיה שגרמה להצגת "אין דגים באקווריום זה" עבור אקווריומים מאוכלסים
  - עודכן `transfer.service.js` לעבוד עם המבנה החדש של `farmFish` במקום המבנה הישן
  - פונקציה `getFishInAquarium` עודכנה לסנן דגים לפי `aquariumId`
  - פונקציה `transferFish` עודכנה לעבוד ישירות עם קולקציית `farmFish`

### שיפורים 🔧
- **שיפור עיצוב מודל העברת דגים**: המודל כעת מסודר יותר עם גלילה נכונה
  - אזור התוכן מתגלגל בנפרד מהכותרת והכפתורים
  - הכפתורים תמיד נראים בתחתית המודל
  - חוויית משתמש משופרת עם רשימות ארוכות של אקווריומים

---

## [1.6.1] - 2025-12-19

### שיפורים 🔧
- **השלמה אוטומטית לשמות דגים**: נוסף autocomplete לשדות הקלדת פרטי דגים
  - השלמה אוטומטית לשם עברי - על בסיס דגים קודמים
  - השלמה אוטומטית לשם מדעי - מתעדכן אוטומטית בעת בחירת שם עברי מוכר
  - מושך נתונים גם מפריטי קליטה (reception_items) וגם מדגי החווה (farmFish)
  - הדגים הפופולריים ביותר מופיעים ראשונים ברשימה
- פישוט של פונקציית `getPreviousFishNames` - מתמקדת רק בשמות ללא מעקב אחר גדלים

### תיקוני באגים 🐛
- **תוקן מיון רשימות אקווריומים**: מיון מספרי תקין (1, 2, 3... 10, 11) במקום מיון טקסטואלי (1, 10, 11... 2, 20)
  - תוקן ב-`getAquariums`, `getEmptyAquariums`, `getAquariumsByRoom`
  - המיון מבוצע בצד הלקוח לאחר קבלת הנתונים מ-Firestore

---

## [1.6.0] - 2025-12-19

### שינויים משמעותיים 🚀
- **ניהול דגים מתוך כרטיס האקווריום**: כעת ניתן להוסיף ולערוך דגים ישירות מכרטיס האקווריום
  - כפתור **"➕ הוסף דג"** באקווריומים ריקים - מוסיף דג חדש ישירות לאקווריום
  - כפתור **"🐠 ערוך דגים"** באקווריומים תפוסים - לניהול הדגים הקיימים
  - חוסך לחיצת כפתור - פשוט יותר ומהיר יותר!

### תכונות חדשות ✨
- **מסך ניהול דגים לאקווריום** (AquariumFishModal):
  - הוספת דג חדש ישירות לאקווריום
  - עריכת כמויות דגים קיימים
  - מחיקת דגים
  - תצוגה ברורה של כל הדגים באקווריום
  - תמיכה במספר מינים באותו אקווריום

### שיפורים 🔧
- **הסרת "דגים לאקווריום"**: מחקנו את הקטגוריה המבלבלת
  - אין יותר מושג של "דגים לא משויכים"
  - כל דג חייב להיות משוייך לאקווריום מרגע היצירה
  - זרימת עבודה הרבה יותר הגיונית
- עדכון `farm-fish.service`: תמיכה בעדכון דגים והקצאה ישירה לאקווריום
- תיקון `.env.example`: שימוש ב-`VITE_` במקום `REACT_APP_`

### הסרות 🗑️
- הוסר FarmFishModal ממסך הבית
- הוסר הכפתור "דגים לאקווריום" מדף הבית

---

## [1.2.0] - 2025-12-09

### תכונות חדשות ✨
- **מערכת קליטת דגים (Reception System)**: מערכת מלאה לתכנון וקבלת משלוחי דגים
  - **תוכנית קליטה**: יצירה וניהול של תוכניות קליטה עם תאריך צפוי ואסמכתה
  - **איכלוס ידני**: הוספה ידנית של דגים לתוכנית עם:
    - בחירת חדר/אזור
    - בחירת אקווריום יעד
    - הזנת פרטי הדג (שם עברי, שם מדעי, גודל, מספר ארגז, קוד)
  - **קבלת דגים**: ממשק לקבלה פיזית של דגים עם:
    - רשימת דגים ממתינים לקבלה
    - קופסאות בחירה לסימון קבלה
    - הוספה אוטומטית של דגים לאקווריום בעת סימון קבלה
    - מעקב התקדמות בגרף
  - תצוגת תוכניות קליטה עם סינון לפי סטטוס
  - ניהול כל התוכניות מדף הבית
  - הכנה לאינטגרציה עם ייבוא Excel בשלב הבא

### שיפורים 🔧
- אפשרות חדשה בעמוד הבית: כפתור "איכלוס אקווריומים" (🏠)
- עדכון מודל fish_instances עם גודל, קוד, וריכוז עזור בעת קבלה
- מעקב מלא של אחוז הקבלה בתוכניות

---

## [1.1.2] - 2025-12-07

### שיפורים 🔧
- **סקריפט אוטומטי לעדכון גרסאות**: נוסף סקריפט שמעדכן את כל קבצי הגרסה בפקודה אחת
  - `npm run version:patch` - תיקון באג (1.0.0 → 1.0.1)
  - `npm run version:minor` - תכונה חדשה (1.0.0 → 1.1.0)
  - `npm run version:major` - שינוי משמעותי (1.0.0 → 2.0.0)
  - מעדכן אוטומטית: package.json, src/version.js, תאריך
  - מזכיר לעדכן את CHANGELOG.md
  - מונע שכחת עדכון גרסה

---

## [1.1.1] - 2025-12-07

### תיקוני באגים 🐛
- תוקן: שגיאת `ReferenceError: setShowNewRoomInput is not defined` ביצירת אקווריום
  - הוסרו הפניות למשתני state שנמחקו בגרסה קודמת

---

## [1.1.0] - 2025-12-07

### תכונות חדשות ✨
- **מערכת העברת דגים**: מערכת מלאה להעברת דגים בין אקווריומים
  - ממשק 3 שלבים: בחירת מקור → בחירת דג וכמות → בחירת יעד
  - סינון לפי חדרים
  - מעקב אחר כמויות ועדכון אוטומטי של סטטוס האקווריומים
  - זמין מדף הבית, עמוד האקווריומים, ומודל עריכה

- **ניהול מיקומים משופר**: דף הגדרות מרכזי לניהול מיקומים
  - הוספה, עריכה ומחיקה של מיקומים
  - מניעת מחיקת מיקומים בשימוש
  - תצוגת מספר אקווריומים לכל מיקום
  - קישור ישיר מטפסי האקווריומים לדף ניהול המיקומים

### תיקוני באגים 🐛
- תוקן: שמירת מיקומים חדשים במסד הנתונים
- תוקן: שגיאת `TypeError: r is not a function` בדף ההגדרות
- תוקן: סדר ה-spread במיגרציה של הגדרות החווה (מונע דריסת ערכים)

### שיפורים 🔧
- הוסר קוד מיותר (206 שורות הוסרו, 58 נוספו)
- ממשק פשוט יותר לניהול מיקומים
- הודעות שגיאה מפורטות יותר
- עדכון React ל-19.2.1 (תיקון אבטחה CVE-2025-55182)

---

## [1.0.0] - 2025-12-06

### שחרור ראשוני 🎉
- מערכת ניהול חוות דגים מבוססת Firebase
- אימות משתמשים עם Google Sign-In
- ניהול אקווריומים (הוספה, עריכה, מחיקה)
- ייבוא משלוחים מקבצי Excel
- ניהול מלאי דגים
- ממשק בעברית
- תמיכה ב-PWA
